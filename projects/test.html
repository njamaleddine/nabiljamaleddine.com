<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">  
    <title>Nabil's Portfolio / Projects / Earthquake WebService</title>
    <link rel="icon" href="/favicon.png" />
    <link rel="apple-touch-icon-precomposed" href="/favicon.png" />
    <link rel="stylesheet" type="text/css" href="/css/index.css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
  	<script>
  		var today = new Date(); //Get current date
  		var earthquakeArray = [];

  		/* Format datetime key from Geonames REST 
         To return proper date format specify 0 for returnVal.
         To return proper time format specify 1 for returnval. */
      function formatDate(datetime, returnVal){
        var date, time;

        datetime = datetime.split(" ");
        date = datetime[0];
        time = datetime[1];

        if(returnVal === 0){
          return date;
        }
        else{
          return time;
        }
      }

  		/* Get Date as YYYY-MM-DD  */
  		function getDateFormated(date){
  		  var day = date.getDate();
  		  var month = date.getMonth()+1;
  		  var year = date.getFullYear();
  		
  		  if(day < 10){
  		    day='0'+day
  		  } 
  		  if(month < 10){
  		    month='0'+month
  		  }
  		  return date = year+'-'+month+'-'+day;
  		}

  		/* Get the top 10 earthquakes in the last 12 months */
  		$(function plotTopTenEarthquakes(){
  		      earthquakeDataURL = "http://api.geonames.org/earthquakesJSON?north=100&south=-100&east=180&west=-180&date="+getDateFormated(today)+"&maxRows=70&minMagnitude=6.8&username=njamaleddine";

  		      $.ajax({
			       url: earthquakeDataURL,
			       dataType: 'json',
			       success: function(data) {
			          $.each(data.earthquakes, function(index, element) {
		          		earthquakeArray[index] = new Object();

									//Store earthquake information in an array of objects in case information needs to be manipulated or stored in a database for later projects
	                earthquakeArray[index].eqid = element.eqid;
	                earthquakeArray[index].magnitude = element.magnitude;
	                earthquakeArray[index].longitude = element.lng;
	                earthquakeArray[index].source1 = element.src; 
	                earthquakeArray[index].date = formatDate(element.datetime, 0);
	                earthquakeArray[index].timeOfDay = formatDate(element.datetime, 1);
	                earthquakeArray[index].depth = element.depth;
	                earthquakeArray[index].latitude = element.lat;  

							$("#content_area").append("<p>ID: "+earthquakeArray[index].eqid + " | magnitude: " + earthquakeArray[index].magnitude + " | longitude: "+ earthquakeArray[index].longitude +" | country:  "+ earthquakeArray[index].country + " | date: " + earthquakeArray[index].date + " | depth: "+ earthquakeArray[index].depth + " | latitude " + earthquakeArray[index].latitude +"</p>");
					
			          });
			          // sort Earthquake by magnitude, only return 10
			          earthquakeArray = sortEarthquakes(earthquakeArray);
			       },
			       error: function() {
			       	alert("1");
			          return false;
			       }
			    });
  		  });
				
				function sortEarthquakes(earthquakeArray){
					var topEarthquakes = [];
					var topTenEarthquakes = [];
					var lastYear = new Date(); //This date today but last year.
					lastYear.setMonth(lastYear.getMonth()-12); //Ex: 2013 - 1 = 2012

					//Get length of the array from the dates in the past 12 months
					for(var i = 0; i < earthquakeArray.length; ++i){
						if(earthquakeArray[i].date > getDateFormated(lastYear)){
							topEarthquakes[i] = earthquakeArray[i];
						}
					}

						alert("Sorting now");
						topTenEarthquakes = sortMagnitude(topEarthquakes);
				}

				/* swap function */
				function swap(array, i, index){
					var temp = array[i];
					array[i] = array[index];
					array[index] = temp;
				}

				/* Bubblesort implementation for sorting magnitude. Sufficient for our data set size. */
				function sortMagnitude(topEarthquakes){
					var returnArray = []; //only the 10 ten are returned
					var i = 0;
					var limit = topEarthquakes.length-1;
					var swapFlag = true;

					while(limit !== 0 && swapFlag === true){
						swapFlag = false;

						while(i !== limit){
							if(topEarthquakes[i].magnitude <= topEarthquakes[i+1].magnitude){
								swap(topEarthquakes, i, i+1);
								swapFlag = true;
							}
							i++;
						}
						limit--;
						i = 0;
					}
						for(var i = 0; i < 10; ++i){
							returnArray[i] = topEarthquakes[i];
						}
					return returnArray;
				}

		</script>
		<div id="content_area"></div>
	</body>
</html>